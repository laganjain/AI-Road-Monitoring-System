import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  sendPasswordResetEmail,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp,
  query,
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import { firebaseConfig } from "./firebaseConfig.js";


// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();


// UI elements
const loginSection = document.getElementById("login-section");
const dashboardSection = document.getElementById("dashboard-section");

const loginMsg = document.getElementById("login-message");
const dashMsg = document.getElementById("dashboard-message");
const reportList = document.getElementById("report-list");



// Auth State Change
onAuthStateChanged(auth, (user) => {
  if (user) {
    loginSection.classList.add("hidden");
    dashboardSection.classList.remove("hidden");
    dashMsg.innerText = "Logged in as " + user.email;
  } else {
    dashboardSection.classList.add("hidden");
    loginSection.classList.remove("hidden");
  }
});


// LOGIN
document.getElementById("login-btn").onclick = async () => {
  let email = document.getElementById("email").value;
  let pass = document.getElementById("password").value;

  try {
    await signInWithEmailAndPassword(auth, email, pass);
    loginMsg.innerHTML = "<span class='success'>Login successful</span>";
  } catch (e) {
    loginMsg.innerHTML = "<span class='error'>" + e.message + "</span>";
  }
};


// SIGNUP
document.getElementById("signup-btn").onclick = async () => {
  let email = document.getElementById("email").value;
  let pass = document.getElementById("password").value;

  try {
    await createUserWithEmailAndPassword(auth, email, pass);
    loginMsg.innerHTML = "<span class='success'>Account created</span>";
  } catch (e) {
    loginMsg.innerHTML = "<span class='error'>" + e.message + "</span>";
  }
};


// FORGOT PASSWORD
document.getElementById("forgot-pass").onclick = async () => {
  let email = document.getElementById("email").value;

  try {
    await sendPasswordResetEmail(auth, email);
    loginMsg.innerHTML = "<span class='success'>Reset email sent!</span>";
  } catch (e) {
    loginMsg.innerHTML = "<span class='error'>" + e.message + "</span>";
  }
};


// LOGOUT
document.getElementById("logout-btn").onclick = async () => {
  await signOut(auth);
};


// MANUAL REPORT
document.getElementById("report-btn").onclick = async () => {
  let type = document.querySelector("input[name='incident']:checked")?.value;
  let location = document.getElementById("location").value;

  if (!type || !location) {
    dashMsg.innerHTML = "<span class='error'>Select incident + enter location</span>";
    return;
  }

  await addDoc(collection(db, "road_reports"), {
    type,
    locationName: location,
    userEmail: auth.currentUser.email,
    userId: auth.currentUser.uid,
    timestamp: serverTimestamp(),
    source: "manual"
  });

  dashMsg.innerHTML = "<span class='success'>Report submitted</span>";
  document.getElementById("location").value = "";
};


// SENSOR REPORT
document.getElementById("sensor-btn").onclick = async () => {
  let type = document.querySelector("input[name='sensorIncident']:checked")?.value;
  let location = document.getElementById("sensor-location").value;

  if (!type || !location) {
    loginMsg.innerHTML = "<span class='error'>Select incident + enter location</span>";
    return;
  }

  await addDoc(collection(db, "road_reports"), {
    type,
    locationName: location,
    userEmail: "Sensor Module",
    userId: "sensor_auto",
    timestamp: serverTimestamp(),
    source: "sensor",
    sensorData: { vibration: Math.random() * 5 }
  });

  loginMsg.innerHTML = "<span class='success'>Sensor report sent</span>";
  document.getElementById("sensor-location").value = "";
};



// REAL-TIME LISTENER (Newest first)
const q = query(collection(db, "road_reports"), orderBy("timestamp", "desc"));

onSnapshot(q, (snapshot) => {
  reportList.innerHTML = "";
  snapshot.forEach((doc) => {
    let d = doc.data();
    let time = d.timestamp ? d.timestamp.toDate().toLocaleString() : "Pending";

    let li = document.createElement("li");
    li.innerHTML = `
      <strong>${d.type}</strong> at ${d.locationName}<br>
      Reported by: ${d.userEmail}<br>
      Time: ${time} <br>
      Source: ${d.source}
    `;
    reportList.appendChild(li);
  });
});
